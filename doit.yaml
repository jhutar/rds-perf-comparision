---
- name: Deploy EC2 and RDS Infrastructure
  hosts: localhost
  connection: local
  gather_facts: false
  tags:
    - deploy
  tasks:
    - name: Create a VPC
      amazon.aws.ec2_vpc_net:
        name: "{{ project_name }}-vpc"
        cidr_block: "10.0.0.0/16"
        region: "{{ aws_region }}"
        tags:
          Project: "{{ project_name }}"
          Owner: "{{ owner_name }}"
      register: vpc

    - name: Create subnet 1
      amazon.aws.ec2_vpc_subnet:
        state: present
        vpc_id: "{{ vpc.vpc.id }}"
        cidr: "10.0.1.0/24"
        az: "{{ aws_az1 }}"
        region: "{{ aws_region }}"
        map_public: yes
        tags:
          Name: "{{ project_name }}-subnet1"
          Project: "{{ project_name }}"
          Owner: "{{ owner_name }}"
      register: subnet1

    - name: Create subnet 2
      amazon.aws.ec2_vpc_subnet:
        state: present
        vpc_id: "{{ vpc.vpc.id }}"
        cidr: "10.0.2.0/24"
        az: "{{ aws_az2 }}"
        region: "{{ aws_region }}"
        map_public: yes
        tags:
          Name: "{{ project_name }}-subnet2"
          Project: "{{ project_name }}"
          Owner: "{{ owner_name }}"
      register: subnet2

    - name: Create an internet gateway
      amazon.aws.ec2_vpc_igw:
        vpc_id: "{{ vpc.vpc.id }}"
        region: "{{ aws_region }}"
        tags:
          Project: "{{ project_name }}"
          Owner: "{{ owner_name }}"
      register: igw

    - name: Create a route table
      amazon.aws.ec2_vpc_route_table:
        vpc_id: "{{ vpc.vpc.id }}"
        region: "{{ aws_region }}"
        subnets:
          - "{{ subnet1.subnet.id }}"
        routes:
          - dest: "0.0.0.0/0"
            gateway_id: "{{ igw.gateway_id }}"
        tags:
          Project: "{{ project_name }}"
          Owner: "{{ owner_name }}"
      register: route

    - name: Create a security group for the EC2 instance
      amazon.aws.ec2_group:
        name: "{{ project_name }}-ec2-sg"
        description: "Allow SSH from anywhere and all outbound traffic"
        vpc_id: "{{ vpc.vpc.id }}"
        region: "{{ aws_region }}"
        rules:
          - proto: tcp
            ports:
              - 22
            cidr_ip: "0.0.0.0/0"
            rule_desc: "Allow SSH from anywhere"
        rules_egress:
          - proto: all
            cidr_ip: "0.0.0.0/0"
            rule_desc: "Allow all outbound traffic"
        tags:
          Project: "{{ project_name }}"
          Owner: "{{ owner_name }}"
      register: ec2_sg

    - name: Create a security group for the RDS instance
      amazon.aws.ec2_group:
        name: "{{ project_name }}-rds-sg"
        description: "Allow PostgreSQL traffic from the EC2 security group"
        vpc_id: "{{ vpc.vpc.id }}"
        region: "{{ aws_region }}"
        rules:
          - proto: tcp
            ports:
              - 5432
            group_id: "{{ ec2_sg.group_id }}"
            rule_desc: "Allow PostgreSQL traffic from EC2"
        tags:
          Project: "{{ project_name }}"
          Owner: "{{ owner_name }}"
      register: rds_sg

    - name: Create RDS subnet group
      amazon.aws.rds_subnet_group:
        state: present
        name: "{{ project_name }}-rds-subnet-group"
        description: "Subnet group for RDS"
        region: "{{ aws_region }}"
        subnets:
          - "{{ subnet1.subnet.id }}"
          - "{{ subnet2.subnet.id }}"
        tags:
          Project: "{{ project_name }}"
          Owner: "{{ owner_name }}"
      register: rds_subnet_group

    - name: Create the RDS instance
      amazon.aws.rds_instance:
        state: "running"
        allocated_storage: "{{ aws_rds_storage }}"
        max_allocated_storage: "{{ aws_rds_storage }}"
        allow_major_version_upgrade: false
        auto_minor_version_upgrade: false
        availability_zone: "{{ aws_az1 }}"
        backup_retention_period: 0
        db_instance_class: "{{ aws_rds_instance_type }}"
        db_name: "{{ ( project_name + '-rds' ) | regex_replace('[^a-zA-Z0-9]+', '') }}"
        db_instance_identifier: "{{ ( project_name + '-rds' ) | regex_replace('[^a-zA-Z0-9]+', '') }}"
        db_subnet_group_name: "{{ rds_subnet_group.subnet_group.name }}"
        deletion_protection: false
        enable_performance_insights: true
        engine: "{{ aws_rds_engine }}"
        engine_version: "{{ aws_rds_engine_version }}"
        iops: null   # Is only relevant when using storage_type is set to io1
        master_username: "{{ aws_rds_user }}"
        master_user_password: "{{ aws_rds_password }}"
        performance_insights_retention_period: 7
        port: "{{ aws_rds_port }}"
        publicly_accessible: false
        region: "{{ aws_region }}"
        storage_encrypted: true
        storage_type: "gp3"
        vpc_security_group_ids:
          - "{{ rds_sg.group_id }}"
        wait: yes
        tags:
          Name: "{{ project_name }}-rds"
          Project: "{{ project_name }}"
          Owner: "{{ owner_name }}"
      register: rds_instance

    - debug:
        var: rds_instance

    - name: Launch the EC2 instance
      amazon.aws.ec2_instance:
        state: "running"
        name: "{{ project_name }}-vm"
        key_name: "{{ aws_ec2_ssh_key_name }}"
        instance_type: "{{ aws_ec2_instance_type }}"
        image:
          id: "{{ aws_ec2_ami_id }}"
        region: "{{ aws_region }}"
        network_interfaces:
          - assign_public_ip: true
            delete_on_termination: true
            groups:
              - "{{ ec2_sg.group_id }}"
            subnet_id: "{{ subnet1.subnet.id }}"
        filters:
          tag:Name: "{{ project_name }}-vm"
          tag:Project: "{{ project_name }}"
          tag:Owner: "{{ owner_name }}"
          instance-state-name: "running"
        tags:
          Project: "{{ project_name }}"
          Owner: "{{ owner_name }}"
        termination_protection: false
        wait: yes
        wait_timeout: 600
      register: ec2_instance

    - name: Add new instance to host group
      add_host:
        name: "{{ ec2_instance.instances[0].network_interfaces[0].association.public_ip }}"
        groups: new_ec2_instances
        # Additional variabes needed in a test phase:
        ansible_user: ec2-user
        ansible_ssh_private_key_file: "{{ aws_ec2_ssh_private_key_file }}"
        rds_instance_endpoint: "{{ rds_instance.endpoint.address }}"

    - name: Wait for SSH to come up
      wait_for:
        host: "{{ ec2_instance.instances[0].network_interfaces[0].association.public_ip }}"
        port: 22
        delay: 15
        timeout: 320
        state: started

    - name: Display connection information
      debug:
        msg:
          - "Using these AWS entities:"
          - "  VPC {{ vpc.vpc.id }}"
          - "  subnet 1 {{ subnet1.subnet.id }}"
          - "  subnet 2 {{ subnet2.subnet.id }}"
          - "  subnet group for RDS {{ rds_subnet_group.subnet_group.db_subnet_group_name }}"
          - "  route {{ route.route_table.id }}"
          - "  gateway {{ igw.gateway_id }}"
          - "  securty group for VM {{ ec2_sg.group_id }}"
          - "  securty group for RDS {{ rds_sg.group_id }}"
          - "EC2 Instance Public IP: {{ ec2_instance.instances[0].network_interfaces[0].association.public_ip }}"
          - "  to connect to it: ssh -i {{ aws_ec2_ssh_private_key_file }} ec2-user@{{ ec2_instance.instances[0].network_interfaces[0].association.public_ip }}"
          - "RDS Endpoint: {{ rds_instance.endpoint.address }}"
          - "  to connect to it (from VM): PGPASSWORD=... psql --host {{ rds_instance.endpoint.address }} --port {{ aws_rds_port }} --username {{ aws_rds_user }} postgres"


- name: Configure newly created EC2 instance
  hosts: new_ec2_instances
  become: yes
  gather_facts: yes
  tags:
    - test

  tasks:
    - name: Install Podman
      yum:
        name: podman
        state: present

    - name: Pull HammerDB PostgreSQL container image
      command: podman pull docker.io/tpcorg/hammerdb:postgres

    - name: Deploy HammerDB test scripts
      template:
          src: "{{ item.src }}"
          dest: "{{ item.dest }}"
      loop:
        - src: "templates/hammerdb-tpcc-setup.tcl.j2"
          dest: "setup.tcl"
        - src: "templates/hammerdb-tpcc-run.tcl.j2"
          dest: "run.tcl"

    - name: Setup HammerDB test
      shell: |
        cat setup.tcl | podman run --network=host --rm -it --name hammerdb docker.io/tpcorg/hammerdb:postgres ./hammerdbcli
      register: hammerdb_setup_out

    - name: Show test setup output
      debug:
        var: hammerdb_setup_out

    - name: Check test setup was OK
      vars:
        lines_all: "{{ hammerdb_setup_out.stdout_lines | select('match', '.*:FINISHED .*') }}"
        lines_succeeded: "{{ lines_all | select('match', '.*:FINISHED SUCCESS') }}"
      assert:
        that:
          - lines_all|length > 0
          - lines_all|length == lines_succeeded|length

    - name: Run HammerDB test
      shell: |
        cat run.tcl | podman run --network=host --rm -it --name hammerdb docker.io/tpcorg/hammerdb:postgres ./hammerdbcli
      register: hammerdb_run_out

    - name: Show test run output
      debug:
        var: hammerdb_run_out

    - name: Check test run was OK
      vars:
        lines_all: "{{ hammerdb_run_out.stdout_lines | select('match', '.*:FINISHED .*') }}"
        lines_succeeded: "{{ lines_all | select('match', '.*:FINISHED SUCCESS') }}"
      assert:
        that:
          - lines_all|length > 0
          - lines_all|length == lines_succeeded|length

    - name: Parse new orders per minute value out of output
      set_fact:
        result_nopm: "{{ hammerdb_run_out.stdout | regex_search('TEST RESULT : System achieved ([0-9]+) NOPM from [0-9]+ PostgreSQL TPM','\\1') | first }}"

    - name: Parse transactions per minute value out of output
      set_fact:
        result_tpm: "{{ hammerdb_run_out.stdout | regex_search('TEST RESULT : System achieved [0-9]+ NOPM from ([0-9]+) PostgreSQL TPM','\\1') | first }}"

    - name: Show results
      debug:
        msg: "RESULTS: NOPM = {{ result_nopm }}, TPM = {{ result_tpm }}"


- name: Cleanup Infrastructure
  hosts: localhost
  connection: local
  gather_facts: false
  tags:
    - cleanup

  tasks:
    - name: Terminate EC2 instances
      amazon.aws.ec2_instance:
        state: absent
        region: "{{ aws_region }}"
        wait: yes
        filters:
          tag:Name: "{{ project_name }}-vm"
          tag:Project: "{{ project_name }}"
          tag:Owner: "{{ owner_name }}"

    - name: Delete the RDS instance
      amazon.aws.rds_instance:
        state: absent
        db_instance_identifier: "{{ ( project_name + '-rds' ) | regex_replace('[^a-zA-Z0-9]+', '') }}"
        region: "{{ aws_region }}"
        skip_final_snapshot: yes
        wait: yes
      ignore_errors: yes

    - name: Delete RDS subnet group
      amazon.aws.rds_subnet_group:
        state: absent
        name: "{{ project_name }}-rds-subnet-group"
        region: "{{ aws_region }}"
      ignore_errors: yes

    - name: Delete VPC and its resources
      amazon.aws.ec2_vpc_net:
        name: "{{ project_name }}-vpc"
        state: absent
        region: "{{ aws_region }}"
        cidr_block: "10.0.0.0/16"
      ignore_errors: yes
